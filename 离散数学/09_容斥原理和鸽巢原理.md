# 第9章 容斥原理和鸽巢原理

## 9.1 容斥原理

### 9.1.1 二个集合的容斥原理

对于任意两个有限集合A和B，有：
|A∪B| = |A| + |B| - |A∩B|

**直观解释**：计算A∪B的元素个数时，先计算|A|，再计算|B|，但A∩B中的元素被重复计算了一次，所以要减去|A∩B|。

### 9.1.2 三个集合的容斥原理

对于任意三个有限集合A、B、C，有：
|A∪B∪C| = |A| + |B| + |C| - |A∩B| - |A∩C| - |B∩C| + |A∩B∩C|

**解释**：先加三个集合的元素个数，然后减去两两交集（因为重复计算），最后加上三者交集（因为在减去两两交集时被多减了一次）。

### 9.1.3 n个集合的容斥原理

**定理9.1.1**（容斥原理的一般形式）设A₁, A₂, ..., Aₙ是有限集合，则：
|A₁∪A₂∪...∪Aₙ| = Σ|Aᵢ| - Σ|Aᵢ∩Aⱼ| + Σ|Aᵢ∩Aⱼ∩Aₖ| - ... + (-1)^{n+1}|A₁∩A₂∩...∩Aₙ|

其中：
- 第一个Σ表示对所有单个集合求和（i=1到n）
- 第二个Σ表示对所有二个集合的交集求和（i<j）
- 第三个Σ表示对所有三个集合的交集求和（i<j<k）
- 以此类推

### 9.1.4 容斥原理的补集形式

设S为全集，A₁, A₂, ..., Aₙ为S的子集，则S中不属于任何Aᵢ的元素个数为：
|S - (A₁∪A₂∪...∪Aₙ)| = |S| - |A₁∪A₂∪...∪Aₙ|

利用容斥原理的一般形式：
|S - (A₁∪...∪Aₙ)| = |S| - Σ|Aᵢ| + Σ|Aᵢ∩Aⱼ| - ... + (-1)ⁿ|A₁∩...∩Aₙ|

### 9.1.5 错排问题的容斥解法

**定理9.1.2** n个元素的错排数为：
D(n) = n! - C(n,1)(n-1)! + C(n,2)(n-2)! - ... + (-1)ⁿC(n,n)0!
     = n!Σ_{k=0}^n (-1)ᵏ/k!

**证明**：设S为n个元素的所有排列的集合，Aᵢ表示第i个元素在自然位置上的排列集合。
则错排数就是不在任何Aᵢ中的排列数。

## 9.2 棋盘多项式与有限制排列

### 9.2.1 棋盘多项式的定义

**定义9.2.1** 对于n×n的棋盘C，rₖ(C)表示在C上放置k个非攻击性棋子（任意两个不在同一行或同一列）的方法数。

棋盘C的**棋盘多项式**定义为：
R(C, x) = Σ_{k≥0} rₖ(C)xᵏ

其中r₀(C) = 1（空放）。

### 9.2.2 棋盘多项式的性质

1. **乘法性质**：若棋盘C由两个不同行不同列的子棋盘C₁和C₂组成，则R(C, x) = R(C₁, x) · R(C₂, x)
2. **加法性质**：对于有禁区的排列，利用棋盘多项式可以求解

### 9.2.3 有限制排列

设S为{1,2,...,n}的全排列集合，对于某些位置i限制不能放某些值，可以用棋盘多项式来解决。

## 9.3 一般公式

### 9.3.1 偏序集和Möbius反演

设(P, ≤)是有限偏序集，定义Möbius函数μ(x,y)：
- μ(x,x) = 1
- μ(x,y) = -Σ_{x≤z<y} μ(x,z)，当x<y时
- μ(x,y) = 0，当x≰y时

**Möbius反演公式**：设f, g是定义在偏序集P上的函数，
若g(x) = Σ_{y≤x} f(y)，则f(x) = Σ_{y≤x} μ(y,x)g(y)

### 9.3.2 容斥原理的一般化

容斥原理可以看作在偏序集({子集}, ⊆)上的Möbius反演的特例。

## 9.4 二项式反演与Möbius反演

### 9.4.1 二项式反演

**定理9.4.1**（二项式反演公式）：
如果 f(n) = Σ_{k=0}^n C(n,k) g(k)，则 g(n) = Σ_{k=0}^n (-1)^{n-k} C(n,k) f(k)

等价形式：
如果 g(n) = Σ_{k=0}^n (-1)ᵏ C(n,k) f(k)，则 f(n) = Σ_{k=0}^n (-1)ᵏ C(n,k) g(k)

### 9.4.2 应用示例

**例9.4.1** 设aₙ表示n元集合的排列数，bₙ表示n元集合的错排数。
则 aₙ = Σ C(n,k) b_{n-k}，利用二项式反演可得bₙ的公式。

## 9.5 鸽巢原理

### 9.5.1 简单鸽巢原理

**定理9.5.1**（鸽巢原理）如果n+1只鸽子飞进n个鸽巢，则至少有一个鸽巢中有2只或2只以上的鸽子。

**等价表述**：如果将n+1个物体放入n个盒子中，则至少有一个盒子包含2个或2个以上的物体。

### 9.5.2 加强版鸽巢原理

**定理9.5.2** 如果q₁ + q₂ + ... + qₙ - n + 1个物体放入n个盒子中，则或者第1个盒子至少含有q₁个物体，或者第2个盒子至少含有q₂个物体，...，或者第n个盒子至少含有qₙ个物体。

**特例**：如果kn+1个物体放入n个盒子中，则至少有一个盒子含有k+1个或更多的物体。

### 9.5.3 鸽巢原理的应用

**例9.5.1** 证明：任意6个人中，要么有3个人相互认识，要么有3个人相互不认识。

将问题转换为完全图K₆的边着色问题（红色表示认识，蓝色表示不认识）。
对任意顶点v，它关联5条边，由鸽巢原理，至少有⌈5/2⌉=3条边同色。
设这3条边是{v,a}, {v,b}, {v,c}且同为红色。
如果a,b,c之间有任何一条红边（如{a,b}），则v,a,b形成红色三角形；
否则a,b,c之间都是蓝边，形成蓝色三角形。

## 9.6 Ramsey问题和Ramsey数

### 9.6.1 Ramsey问题

**定义9.6.1** Ramsey理论研究的是：在足够大的结构中，必定存在特定的子结构。

### 9.6.2 Ramsey数

**定义9.6.2** Ramsey数R(r, s)是最小的正整数n，使得将Kₙ的边用红蓝两色着色时，必然存在红色的Kᵣ或蓝色的Kₛ。

**已知的Ramsey数**：
- R(3,3) = 6
- R(3,4) = 9
- R(4,4) = 18
- R(3,5) = 14

### 9.6.3 Ramsey定理

**定理9.6.1**（Ramsey定理）对任意正整数r, s，Ramsey数R(r,s)存在。

**广义Ramsey定理**：对任意正整数r₁, r₂, ..., rₖ，存在正整数R(r₁, r₂, ..., rₖ)，使得将R(r₁, r₂, ..., rₖ)阶完全图的边用k种颜色着色时，必然存在i色的完全子图K_{rᵢ}。

## 9.7 容斥原理的应用

### 9.7.1 欧拉函数的计算

**欧拉函数**φ(n)表示小于n且与n互素的正整数个数。

设n = p₁^{a₁}p₂^{a₂}...pₖ^{aₖ}，则：
φ(n) = n(1-1/p₁)(1-1/p₂)...(1-1/pₖ)

**容斥原理解释**：令Aᵢ表示[1,n]中被pᵢ整除的整数集合，
则φ(n) = n - |A₁∪A₂∪...∪Aₖ|

### 9.7.2 有禁止位的排列

求满足某些限制条件的排列数，如某些位置不能是某些值。

## 9.8 鸽巢原理的高级应用

### 9.8.1 抽屉原理在数论中的应用

**例9.8.1**（Erdős定理）任意n+1个不超过2n的正整数中，必有两个数互素。

### 9.8.2 抽屉原理在几何中的应用

**例9.8.2** 平面上任意5个整点中，必有两个点的中点也是整点。

## 本章小结

1. 容斥原理是处理集合并集计数的重要工具，适用于多个集合的计数问题
2. 棋盘多项式在有限制排列问题中有重要应用
3. Möbius反演是容斥原理的推广，在偏序集上有广泛应用
4. 鸽巢原理表述简单但应用广泛，是证明存在性的重要工具
5. Ramsey理论研究大结构中必然包含的子结构，是组合数学的重要分支
6. 这些原理在数论、几何、图论等领域都有重要应用

## 课后练习

### 选择题

1. 在集合S = {1,2,3,...,100}中，能被2或3整除的数的个数是：
   A. 66
   B. 67
   C. 68
   D. 69

2. 鸽巢原理的加强形式：若有n个盒子和kn+1个物体，则至少有一个盒子包含多少个物体？
   A. k个
   B. k+1个
   C. k+2个
   D. 2k个

3. Ramsey数R(3,3)的值是：
   A. 4
   B. 5
   C. 6
   D. 7

### 解答题

1. 求1到600之间既不能被3整除，也不能被5整除，也不能被7整除的整数个数。

2. 用容斥原理证明欧拉函数公式：φ(n) = n∏_{p|n}(1-1/p)，其中p是n的素因子。

3. 证明：在任意13个人中，至少有2个人生日在同一个月。

4. 在边长为2的正方形内放置5个点，证明至少有两个点的距离不超过√2。

5. 用棋盘多项式方法求解：在3×3棋盘上放置3个非攻击性棋子，但(1,1)和(2,2)位置不能放棋子的方案数。

### 练习题答案

#### 选择题

1. B - 设A为被2整除的数集合，B为被3整除的数集合
   |A| = ⌊100/2⌋ = 50, |B| = ⌊100/3⌋ = 33, |A∩B| = ⌊100/6⌋ = 16
   |A∪B| = 50 + 33 - 16 = 67
   
2. B - 这是加强版鸽巢原理的直接应用，至少有一个盒子包含⌈(kn+1)/n⌉ = k+1个物体
   
3. C - R(3,3)=6，这是经典结果

#### 解答题

1. 解：
   设U = {1, 2, ..., 600}，A为被3整除的数集合，B为被5整除的数集合，C为被7整除的数集合。
   
   |A| = ⌊600/3⌋ = 200
   |B| = ⌊600/5⌋ = 120
   |C| = ⌊600/7⌋ = 85
   |A∩B| = ⌊600/15⌋ = 40
   |A∩C| = ⌊600/21⌋ = 28
   |B∩C| = ⌊600/35⌋ = 17
   |A∩B∩C| = ⌊600/105⌋ = 5
   
   由容斥原理：|A∪B∪C| = 200 + 120 + 85 - 40 - 28 - 17 + 5 = 325
   所求个数 = 600 - 325 = 275

2. 证明：
   设n = p₁^{a₁}p₂^{a₂}...pₖ^{aₖ}
   令Aᵢ表示{1,2,...,n}中被pᵢ整除的数的集合
   
   φ(n) = n - |A₁∪A₂∪...∪Aₖ|
   
   由容斥原理：
   |A₁∪...∪Aₖ| = Σ|Aᵢ| - Σ|Aᵢ∩Aⱼ| + Σ|Aᵢ∩Aⱼ∩Aₗ| - ... + (-1)ᵏ|A₁∩...∩Aₖ|
   
   |Aᵢ| = n/pᵢ
   |Aᵢ∩Aⱼ| = n/(pᵢpⱼ)
   |Aᵢ∩Aⱼ∩Aₗ| = n/(pᵢpⱼpₗ)
   ...
   |A₁∩...∩Aₖ| = n/(p₁p₂...pₖ)
   
   所以：
   φ(n) = n - Σ(n/pᵢ) + Σ(n/(pᵢpⱼ)) - Σ(n/(pᵢpⱼpₗ)) + ... + (-1)ᵏ(n/(p₁p₂...pₖ))
        = n(1 - Σ(1/pᵢ) + Σ(1/(pᵢpⱼ)) - ... + (-1)ᵏ(1/(p₁p₂...pₖ)))
        = n(1 - 1/p₁)(1 - 1/p₂)...(1 - 1/pₖ)

3. 证明：
   这是鸽巢原理的直接应用。
   有13个人（物体），12个月（盒子）。
   由鸽巢原理，至少有一个月有⌈13/12⌉ = 2个人生日在该月。

4. 证明：
   将边长为2的正方形四等分，得到4个边长为1的小正方形。
   有5个点（物体）分布在4个小正方形（盒子）中。
   由鸽巢原理，至少有一个小正方形包含2个或以上的点。
   小正方形的对角线长度为√2，所以这两个点之间的距离不超过√2。

5. 解：
   总的3×3棋盘放置3个非攻击性棋子的方案数是3! = 6。
   
   禁止位置：(1,1)和(2,2)
   令A₁表示在(1,1)放置棋子的方案集，A₂表示在(2,2)放置棋子的方案集
   
   |A₁|：固定在(1,1)放一个棋子，剩下8个位置放2个非攻击棋子，等价于2×2棋盘放2个棋子，为2! = 2
   
   |A₂|：固定在(2,2)放一个棋子，剩下8个位置放2个非攻击棋子，也是2
   
   |A₁∩A₂|：同时在(1,1)和(2,2)放棋子，还剩1个棋子放在不与前两个同排同列的位置上
   (1,1)和(2,2)占据第1行、第2行和第1列、第2列，剩余(3,3)可放，所以|A₁∩A₂| = 1
   
   由容斥原理，禁止的方案数 = |A₁∪A₂| = 2 + 2 - 1 = 3
   
   所求方案数 = 6 - 3 = 3